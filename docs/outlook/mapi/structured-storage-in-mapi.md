---
title: Strukturierte Speicher in MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Letzte Änderung: Montag, 9. März 2015'
ms.openlocfilehash: 462ee84d5e9acd26f80bae6516179f21651749be
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 06/11/2018
ms.locfileid: "19795664"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="f7d57-103">Strukturierte Speicher in MAPI</span><span class="sxs-lookup"><span data-stu-id="f7d57-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="f7d57-104">**Betrifft**: Outlook</span><span class="sxs-lookup"><span data-stu-id="f7d57-104">**Applies to**: Outlook</span></span> 
  
<span data-ttu-id="f7d57-105">Strukturierter Speicher bezieht sich auf die hierarchische Organisation der Speicher mit COM eingeführt</span><span class="sxs-lookup"><span data-stu-id="f7d57-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="f7d57-106">In einer Umgebung mit strukturierten Speicher ist Speicher in zwei oder drei Typen von Objekten unterteilt:</span><span class="sxs-lookup"><span data-stu-id="f7d57-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="f7d57-107">Stream-Objekten</span><span class="sxs-lookup"><span data-stu-id="f7d57-107">Stream objects</span></span>
    
- <span data-ttu-id="f7d57-108">Sperren von Objekten bytes</span><span class="sxs-lookup"><span data-stu-id="f7d57-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="f7d57-109">Speicherobjekte</span><span class="sxs-lookup"><span data-stu-id="f7d57-109">Storage objects</span></span>
    
<span data-ttu-id="f7d57-110">Stream und Sperre Bytes sind Low-Level-Objekte, die direkt auf die Daten zugreifen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="f7d57-111">Stream-Objekten implementieren die **IStream** -Schnittstelle die Methoden zum Lesen, schreiben, Positionierung und kopieren Bytes Daten definiert.</span><span class="sxs-lookup"><span data-stu-id="f7d57-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="f7d57-112">Sperren von Bytes Objekten Implementieren einer anderen COM-Schnittstelle, **ILockBytes**Zugriff auf Daten mit einem Bytearray.</span><span class="sxs-lookup"><span data-stu-id="f7d57-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="f7d57-113">Byte-Arrays werden normalerweise verwendet, um angepasste Zugriff auf die zugrunde liegende Speicher bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="f7d57-114">Speicherobjekte werden auf den Datenstrom oder Sperrtyp Byte-Objekten layered; Sie können eine oder mehrere dieser Objekte sowie andere Speicherobjekte enthalten.</span><span class="sxs-lookup"><span data-stu-id="f7d57-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="f7d57-115">Speicherobjekte implementieren die **IStorage** -Schnittstelle die Methoden zum Erstellen, den Zugriff auf und warten geschachtelte Objekte definiert.</span><span class="sxs-lookup"><span data-stu-id="f7d57-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="f7d57-116">Da **IStream** **ILockBytes**und **IStorage** COM-Schnittstellen anstelle von MAPI-Schnittstellen sind, geben Sie ihre Methoden com-Fehler statt MAPI-Werten zurück.</span><span class="sxs-lookup"><span data-stu-id="f7d57-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="f7d57-117">Clients und Aufrufen von Methoden in diese Schnittstellen-Dienstanbieter müssen die API-Funktion **MapStorageSCode** verwenden, um diese Werte in MAPI-Fehlerwerte übersetzt.</span><span class="sxs-lookup"><span data-stu-id="f7d57-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="f7d57-118">Weitere Informationen finden Sie unter [MapStorageSCode](mapstoragescode.md).</span><span class="sxs-lookup"><span data-stu-id="f7d57-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="f7d57-119">Clients und -Dienstanbieter verwenden strukturierten Speicher für das Arbeiten mit Eigenschaften, die zu groß, um mit den **IMAPIProp** Methoden in der Regel großen Zeichenfolge und binäre Eigenschaften beibehalten werden.</span><span class="sxs-lookup"><span data-stu-id="f7d57-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="f7d57-120">Eine allgemeine Möglichkeit, dass Clients oder Dienstanbieter darauf zugreifen wird **IStream** oder **IStorage** als Schnittstellenbezeichner in einem Aufruf der [IMAPIProp::OpenProperty](imapiprop-openproperty.md) -Methode.</span><span class="sxs-lookup"><span data-stu-id="f7d57-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="f7d57-121">Clients rufen beispielsweise **OpenProperty** mit **PR_ATTACH_DATA_BIN** als Eigenschafts-Tag und IID_IStream als Schnittstellenbezeichner auf eine binäre Anlage in einer Nachricht zugreifen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="f7d57-122">Clients und Dienstanbieter implementieren ihrer eigenen Objekte Stream und Speicher oder rufen Sie API-Funktionen für Access Implementierungen von MAPI oder com bereitgestellt wird</span><span class="sxs-lookup"><span data-stu-id="f7d57-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="f7d57-123">Da die angegebenen Implementierungen in den meisten Fällen dienen, müssen Clients und -Dienstanbieter selten eigene erstellen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="f7d57-124">Wenn ein Client-Anrufe **OpenProperty** in einem MAPI-Objekt an eine seiner Eigenschaften ein Speicherobjekt zugreifen, wird der Dienstanbieter in der Regel das Speicherobjekt in direkten Modus geöffnet.</span><span class="sxs-lookup"><span data-stu-id="f7d57-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="f7d57-125">Dies ist jedoch statt erforderlichen Verhaltens typisch.</span><span class="sxs-lookup"><span data-stu-id="f7d57-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="f7d57-126">Clients sollten wird davon ausgegangen, dass alle Speicherobjekte von Dienstanbietern erstellt oder geöffnet wurden durchgeführt werden und einen Anruf an **IStorage::Commit**erfordern.</span><span class="sxs-lookup"><span data-stu-id="f7d57-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="f7d57-127">Sie sollten auch bedenken, dass Änderungen an Speicherobjekte nicht permanent gemacht werden, bis sie **IMAPIProp::SaveChanges** rufen Sie nach der letzten **Commit** in das MAPI-Objekt zu speichern.</span><span class="sxs-lookup"><span data-stu-id="f7d57-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="f7d57-128">Weitere Informationen finden Sie unter [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="f7d57-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="f7d57-129">MAPI- und COM-bieten verschiedene API-Funktionen für definieren oder den Zugriff auf Speicher und Stream-Objekten.</span><span class="sxs-lookup"><span data-stu-id="f7d57-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="f7d57-130">In der folgenden Tabelle werden die häufig verwendeten Funktionen beschrieben.</span><span class="sxs-lookup"><span data-stu-id="f7d57-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="f7d57-131">**Funktionen für den Zugriff auf Speicher- und Stream-Objekten**</span><span class="sxs-lookup"><span data-stu-id="f7d57-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="f7d57-132">**Funktion**</span><span class="sxs-lookup"><span data-stu-id="f7d57-132">**Function**</span></span>|<span data-ttu-id="f7d57-133">**Beschreibung**</span><span class="sxs-lookup"><span data-stu-id="f7d57-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="f7d57-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="f7d57-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="f7d57-135">Erstellt ein Speicherobjekt Zugriff auf einen Datenstrom oder Sperrtyp Byte-Objekt.</span><span class="sxs-lookup"><span data-stu-id="f7d57-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="f7d57-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="f7d57-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="f7d57-137">Erstellt ein Message-Objekt um ein Speicherobjekt zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="f7d57-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="f7d57-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="f7d57-139">Erstellt ein Stream-Objekt, um eine Datei zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="f7d57-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="f7d57-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="f7d57-141">Erstellt ein Stream-Objekt, das die komprimierte oder nicht komprimierte Version eines Stream-Objekts aufbewahren von rich-Text einer Nachricht enthält.</span><span class="sxs-lookup"><span data-stu-id="f7d57-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="f7d57-142">**Um die Namen der Streams in einem bestimmten Substorage abzurufen**</span><span class="sxs-lookup"><span data-stu-id="f7d57-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="f7d57-143">Rufen Sie die Substorage **IStorage::EnumElements** -Methode, um eine **IEnumSTATSTG** Schnittstelle abzurufen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="f7d57-144">Rufen Sie **IEnumSTATSTG::Next** mit beliebig viele **STATSTG** -Strukturen zu einem Zeitpunkt wie möglich.</span><span class="sxs-lookup"><span data-stu-id="f7d57-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="f7d57-145">Wenn Sie jeweils 100 bitten, zurückgegebenen **nächste** in der Regel S_FALSE mit dem Inhalt des _PceltFetched_ legen die Nummer, die tatsächlich abgerufen wurden.</span><span class="sxs-lookup"><span data-stu-id="f7d57-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="f7d57-146">Überprüfen Sie die **STATSTG** -Strukturen, die mit STGTY_STREAM gekennzeichnet wurden.</span><span class="sxs-lookup"><span data-stu-id="f7d57-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="f7d57-147">Freigeben Sie den Parameter _PwcsName_ .</span><span class="sxs-lookup"><span data-stu-id="f7d57-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="f7d57-148">**Zum Erstellen eines Speicherobjekts, um ein vorhandenes Stream oder Sperren-Byte-Objekt zuzugreifen**</span><span class="sxs-lookup"><span data-stu-id="f7d57-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="f7d57-149">Clients aufrufen [HrIStorageFromStream](hristoragefromstream.md).</span><span class="sxs-lookup"><span data-stu-id="f7d57-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="f7d57-150">**Zum Erstellen eines Message-Objekts, um ein vorhandenes Speicherobjekt zugreifen**</span><span class="sxs-lookup"><span data-stu-id="f7d57-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="f7d57-151">Rufen [OpenIMsgOnIStg](openimsgonistg.md)-Dienstanbieter und Clients.</span><span class="sxs-lookup"><span data-stu-id="f7d57-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="f7d57-152">Message-Objekts, das erstellt wird unterscheidet sich von der Message-Objekte in der Regel Zeichenfolgeneigenschaften Nachricht erstellt, dass sie alle nicht unterstützt der [IMessage: IMAPIProp](imessageimapiprop.md) Schnittstellenmethoden wie **IMessage::SubmitMessage**.</span><span class="sxs-lookup"><span data-stu-id="f7d57-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="f7d57-153">Ein optionaler Eingabeparameter für **OpenIMsgOnIStg** ist eine Rückruffunktion, die den [MSGCALLRELEASE](msgcallrelease.md) Prototyp entspricht.</span><span class="sxs-lookup"><span data-stu-id="f7d57-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="f7d57-154">Diese Funktion wird durch die neue Nachrichtenobjekt aufgerufen, wenn die Nachricht Referenzzähler 0 (null) erreicht.</span><span class="sxs-lookup"><span data-stu-id="f7d57-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="f7d57-155">Implementieren eine **MSGCALLRELEASE** -Funktion kann hilfreich sein für die Ausführung der letzten Verarbeitung, bevor die neue Nachricht vollständig entfernt wird.</span><span class="sxs-lookup"><span data-stu-id="f7d57-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="f7d57-156">[OpenStreamOnFile nicht ausgeführt werden](openstreamonfile.md) wird häufig zum Speichern von Dateianlagen, da es einen Datenstrom erstellt, der liest aus und schreibt in eine Datei, verwendet.</span><span class="sxs-lookup"><span data-stu-id="f7d57-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="f7d57-157">**OpenProperty** mit **PR_ATTACH_DATA_BIN** als das Eigenschafts-Tag erstellt einen Stream für die binären Anlagedaten zu speichern.</span><span class="sxs-lookup"><span data-stu-id="f7d57-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="f7d57-158">**Zum Komprimieren und Dekomprimieren einen Stream mit Nachrichtentext in der Rich-Text-Format**</span><span class="sxs-lookup"><span data-stu-id="f7d57-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="f7d57-159">Clients aufrufen [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span><span class="sxs-lookup"><span data-stu-id="f7d57-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="f7d57-160">**WrapCompressedRTFStream** erstellt einen Stream, der den RTF-Stream umbrochen wird.</span><span class="sxs-lookup"><span data-stu-id="f7d57-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="f7d57-161">Der Wrapper-Stream implementiert keine alle **IStream** Methoden. die folgenden Methoden werden ausgeschlossen: **Seek**, **SetSize**, **Wiederherstellen**, **LockRegion**, **UnlockRegion**, **Stat**und **Wenn Sie den Klon**.</span><span class="sxs-lookup"><span data-stu-id="f7d57-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="f7d57-162">Dies ist, da die Streamobjekte, die von **WrapCompressedRTFStream** erstellt keine **SetSize** oder **Stat**unterstützen, ist es keine einfache Möglichkeit zum Erweitern oder ihre Größe abzurufen.</span><span class="sxs-lookup"><span data-stu-id="f7d57-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="f7d57-163">Die beste Strategie ist, wählen Sie eine angemessene Puffergröße sowie das Lesen oder Schreiben in einer Schleife.</span><span class="sxs-lookup"><span data-stu-id="f7d57-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="f7d57-164">COM basiert auf einer Speicher-objektimplementierung basierend auf Bytearray zurück, die ein **IEnumSTATSTG** -Objekt aus der **EnumElements** -Methode zurückgibt, die problematisch ist.</span><span class="sxs-lookup"><span data-stu-id="f7d57-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="f7d57-165">Insbesondere, das die **QueryInterface** -Methode funktioniert nicht ordnungsgemäß.</span><span class="sxs-lookup"><span data-stu-id="f7d57-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="f7d57-166">Dienstanbieter, die ihre eigenen Speicherobjekte mithilfe der COM-Implementierung implementieren sollten erstellen einen thin Wrapper für die **IEnumSTATSTG** -Objekt, leitet Anrufe an die zugrunde liegenden **IEnumSTATSTG** -Methoden, aber implementiert, eine eigene **AddRef **, **Version**, **QueryInterface**und **Clone** -Methoden.</span><span class="sxs-lookup"><span data-stu-id="f7d57-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

